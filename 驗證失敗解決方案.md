# OAuth 驗證失敗解決方案

## 診斷結果

根據診斷工具，發現以下問題：

### ❌ 主要問題：端口 8080 已被占用

這是導致 OAuth 驗證失敗的主要原因。當端口被占用時，OAuth 授權流程無法正常啟動。

## 解決方法

### 方法 1：關閉占用端口的程式（推薦）

1. **找出占用端口的程式：**
   ```powershell
   netstat -ano | findstr :8080
   ```
   這會顯示占用端口 8080 的進程 ID (PID)

2. **查看進程詳情：**
   ```powershell
   tasklist | findstr [PID]
   ```
   將 [PID] 替換為實際的進程 ID

3. **關閉進程：**
   - 如果是您的 Flask 應用程式，在終端按 `Ctrl+C` 停止
   - 如果是其他程式，使用工作管理員結束該進程
   - 或使用命令：
     ```powershell
     taskkill /PID [PID] /F
     ```

### 方法 2：使用其他端口

如果無法關閉占用端口的程式，可以修改代碼使用其他端口（例如 8081）：

1. 修改 `app.py` 中的端口：
   ```python
   app.run(debug=True, host='0.0.0.0', port=8081)  # 改為 8081
   ```

2. 修改 `sheets_service.py` 中的端口：
   ```python
   creds = flow.run_local_server(port=8081, open_browser=True)  # 改為 8081
   ```

3. 在 Google Cloud Console 中添加新端口的 URI：
   - http://localhost:8081/
   - http://localhost:8081
   - http://127.0.0.1:8081/
   - http://127.0.0.1:8081

## 其他常見問題

### 1. redirect_uri_mismatch 錯誤

**原因：** Google Cloud Console 中的重定向 URI 與實際使用的不一致

**解決方法：**
1. 查看瀏覽器地址欄中的錯誤訊息，找到實際使用的 `redirect_uri`
2. 確保該 URI（包括斜線）已在 Google Cloud Console 中註冊
3. 等待 1-2 分鐘讓設定生效

### 2. 憑證檔案問題

**檢查：**
```powershell
python diagnose_oauth.py
```

**解決方法：**
- 確認 `config/keys/client_secrets.json` 檔案存在
- 確認檔案格式正確（JSON）
- 確認客戶端類型（桌面應用程式或網頁應用程式）

### 3. 令牌過期

**解決方法：**
```powershell
del config\keys\token.json
```
然後重新授權

## 完整測試步驟

1. **關閉占用端口的程式**
   ```powershell
   # 找出占用端口的程式
   netstat -ano | findstr :8080
   # 關閉該程式
   ```

2. **確認 Google Cloud Console 設定**
   - 前往 [Google Cloud Console](https://console.cloud.google.com/)
   - 確認已添加所有必要的重定向 URI
   - 儲存設定並等待 1-2 分鐘

3. **刪除舊令牌（如果存在）**
   ```powershell
   del config\keys\token.json
   ```

4. **重新啟動應用程式**
   ```powershell
   python app.py
   ```

5. **觸發同步功能**
   - 應該會自動打開瀏覽器進行 OAuth 授權
   - 如果成功，會看到授權成功的訊息

## 診斷工具

使用診斷工具檢查設定：
```powershell
python diagnose_oauth.py
```

這個工具會檢查：
- ✅ 憑證檔案是否存在和格式正確
- ✅ 令牌檔案狀態
- ✅ 端口是否可用
- ✅ Google Cloud Console 設定建議

