# Netlify 多後端代理設定說明

## 設定說明

系統已設定支援多個後端 IP 的故障轉移功能，透過 Netlify 的 `_redirects` 檔案實現。

## 代理規則設定

在 `_redirects` 檔案中，為每個後端 IP 設定了不同的路徑：

```
/api1/*  → http://151.242.53.185:2998/api/:splat
/api2/*  → http://151.242.53.186:2998/api/:splat
/api3/*  → http://151.242.53.187:2998/api/:splat
/api4/*  → http://151.242.53.188:2998/api/:splat
/api/*   → http://151.242.53.189:2998/api/:splat  (預設)
```

## 故障轉移流程

### Netlify 環境（HTTPS）：
1. 前端嘗試 `/api1/sync` → 代理到 151.242.53.185
2. 如果失敗，嘗試 `/api2/sync` → 代理到 151.242.53.186
3. 如果失敗，嘗試 `/api3/sync` → 代理到 151.242.53.187
4. 如果失敗，嘗試 `/api4/sync` → 代理到 151.242.53.188
5. 如果失敗，嘗試 `/api/sync` → 代理到 151.242.53.189（預設）

### 本地環境（HTTP）：
- 直接嘗試所有後端 IP，不經過代理

## 優點

1. **避免混合內容問題**：所有請求都透過 Netlify 的 HTTPS 代理
2. **自動故障轉移**：如果一個後端失敗，自動嘗試下一個
3. **負載分散**：可以手動調整優先順序

## 如何修改後端 IP

### 方法 1：修改 `_redirects` 檔案

編輯 `_redirects` 檔案，更新對應的 IP 地址：

```apache
# 後端 1：151.242.53.185
/api1/*  http://新的IP:2998/api/:splat  200
```

### 方法 2：修改前端代碼

編輯 `netlify/index.html`，更新 `BACKEND_IPS` 陣列：

```javascript
const BACKEND_IPS = [
    '新的IP1',
    '新的IP2',
    // ...
];
```

同時更新 `apiPaths` 陣列以匹配 `_redirects` 中的路徑。

## 注意事項

1. **路徑順序**：前端嘗試的路徑順序必須與 `_redirects` 中的設定一致
2. **端口一致**：所有後端必須使用相同的端口（目前是 2998）
3. **重新部署**：修改 `_redirects` 後需要重新部署到 Netlify

## 測試

1. 停止其中一個後端服務
2. 在 Netlify 前端點擊「開始發放」
3. 系統應該自動嘗試下一個後端
4. 檢查瀏覽器開發者工具的 Network 標籤，確認請求路徑

## 疑難排解

### 問題：所有後端都無法連接

**可能原因**：
- 所有後端服務都未啟動
- 防火牆阻擋了 Netlify 的請求
- `_redirects` 檔案設定錯誤

**解決方法**：
1. 確認至少一個後端服務正在運行
2. 檢查後端日誌
3. 驗證 `_redirects` 檔案格式正確

### 問題：只使用第一個後端

**可能原因**：
- 第一個後端一直可用，所以不會嘗試其他後端
- 這是正常行為，只有當第一個失敗時才會嘗試下一個

**解決方法**：
- 如果需要測試故障轉移，可以暫時停止第一個後端

