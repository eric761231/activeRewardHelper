# OAuth 驗證失敗原因分析

## 診斷結果
根據診斷工具，基本設定都正常：
- ✅ 憑證檔案存在且格式正確
- ✅ 端口 8080 可用
- ✅ 令牌檔案不存在（首次使用，需要授權）

## 驗證失敗的常見原因

### 1. redirect_uri_mismatch（最常見）

**問題：** Google Cloud Console 中的 URI 與實際使用的 URI 不完全一致

**實際使用的 URI 格式：**
`InstalledAppFlow.run_local_server(port=8080)` 使用的 redirect_uri 格式是：
```
http://localhost:8080/
```
**注意：帶尾隨斜線 `/`**

**解決方法：**
在 Google Cloud Console 的「已授權的重新導向 URI」中，**必須同時添加**：
- `http://localhost:8080/` （帶斜線）
- `http://localhost:8080` （不帶斜線）
- `http://127.0.0.1:8080/` （帶斜線）
- `http://127.0.0.1:8080` （不帶斜線）

### 2. 設定未生效

**問題：** Google Cloud Console 的設定需要時間生效

**解決方法：**
- 儲存設定後，**等待 1-2 分鐘**再測試
- 清除瀏覽器快取
- 使用無痕模式測試

### 3. 使用了錯誤的客戶端類型

**問題：** 代碼會將「網頁應用程式」轉換為「桌面應用程式」格式，但 Google Cloud Console 中的設定可能不正確

**解決方法：**
確保在 Google Cloud Console 中：
- **已授權的 JavaScript 來源**：添加 `http://localhost` 和 `http://localhost:8080`
- **已授權的重新導向 URI**：添加帶斜線和不帶斜線的版本

### 4. 端口被占用

**問題：** 端口 8080 被其他程式占用

**檢查方法：**
```powershell
netstat -ano | findstr :8080
```

**解決方法：**
關閉占用端口的程式，或修改代碼使用其他端口

## 測試步驟

### 步驟 1：運行測試腳本
```powershell
python test_oauth_flow.py
```

這個腳本會：
- 啟動 OAuth 授權流程
- 顯示實際使用的 redirect_uri
- 如果失敗，顯示詳細的錯誤訊息

### 步驟 2：查看實際錯誤

當出現錯誤時：
1. **查看瀏覽器地址欄**中的完整錯誤 URL
2. **找到 `redirect_uri=` 後面的值**
3. **確保這個完全相同的 URI**已在 Google Cloud Console 中註冊

例如，如果錯誤 URL 是：
```
https://accounts.google.com/o/oauth2/v2/auth?...&redirect_uri=http://localhost:8080/&...
```

那麼您需要在 Google Cloud Console 中添加：
- `http://localhost:8080/` （必須完全一致，包括斜線）

### 步驟 3：確認 Google Cloud Console 設定

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 選擇您的專案
3. 前往「API 和服務」→「憑證」
4. 找到您的 OAuth 2.0 客戶端 ID（網頁應用程式）
5. 點擊編輯

**必須添加的 URI：**

#### 已授權的 JavaScript 來源：
```
http://localhost
http://localhost:8080
http://127.0.0.1
http://127.0.0.1:8080
```

#### 已授權的重新導向 URI：
```
http://localhost:8080/
http://localhost:8080
http://127.0.0.1:8080/
http://127.0.0.1:8080
```

**重要：**
- 必須包含帶斜線 `/` 和不帶斜線的版本
- URI 必須完全一致（沒有多餘空格）
- 儲存後等待 1-2 分鐘

## 快速修復檢查清單

- [ ] 確認端口 8080 未被占用
- [ ] 在 Google Cloud Console 中添加了所有必要的 URI（帶斜線和不帶斜線）
- [ ] 儲存設定後等待了 1-2 分鐘
- [ ] 刪除了舊的令牌檔案（如果存在）
- [ ] 查看了實際錯誤訊息中的 redirect_uri
- [ ] 確保 Google Cloud Console 中的 URI 與實際使用的完全一致

## 如果還是不行

1. **運行診斷工具：**
   ```powershell
   python diagnose_oauth.py
   ```

2. **運行測試腳本：**
   ```powershell
   python test_oauth_flow.py
   ```

3. **查看實際錯誤：**
   - 複製瀏覽器地址欄中的完整錯誤 URL
   - 找到 `redirect_uri=` 後面的值
   - 確保這個 URI 已在 Google Cloud Console 中

4. **檢查日誌：**
   - 查看應用程式的日誌輸出
   - 尋找 `redirect_uri` 相關的錯誤訊息

